<odoo>
  <record id="view_maintenance_request_form_external" model="ir.ui.view">
    <field name="name">maintenance.request.form.external</field>
    <field name="model">maintenance.request</field>
    <field name="inherit_id" ref="maintenance.hr_equipment_request_view_form"/>
    <field name="arch" type="xml">

      <!-- ⚠️ Plus AUCUN xpath vers //sheet//div[@name='button_box'] -->

      <!-- Insérer un button_box AVANT le premier group existant -->
      <xpath expr="//sheet/group[1]" position="before">
        <div class="oe_button_box" name="button_box">
          <!-- Smart button : ouvre le PO lié -->
          <button name="action_open_purchase"
                  type="object"
                  class="oe_stat_button"
                  invisible="is_external == False or purchase_id == False"
                  icon="fa-shopping-cart">
            
            <field name="purchase_id" widget="statinfo" string="Bon de commande"/>
          </button>
        </div>
      </xpath>


      <!-- Ajout du flag calculé -->
      <xpath expr="//field[@name='maintenance_type']" position="after">
        <!-- ✅ Nouveau champ radio séparé -->
        <field name="maintenance_flow" widget="radio"/>
        <field name="is_external" invisible="1"/>
      </xpath>

      <!-- Bloc "Sous-traitance" après le group qui contient equipment_id -->
      <xpath expr="//group[.//field[@name='equipment_id']]" position="after">
        <group string="Sous-traitance" invisible="is_external == False">
          <field name="partner_id" options="{'no_create_edit': True}"/>
          <field name="vendor_rma"/>
          <field name="tracking_ref"/>
          <field name="purchase_id" readonly="1" context="{'default_partner_id': partner_id}"/>
          <field name="external_cost" readonly="1"/>
          <field name="date_sent_vendor" readonly="1"/>
          <field name="date_back_vendor" readonly="1"/>
        </group>
      </xpath>

      <!-- Boutons d’action dans le header -->
      <xpath expr="//header" position="inside">
        <button name="action_create_vendor_rfq"
                type="object"
                string="Créer devis fournisseur"
                class="btn-primary"
                invisible="is_external == False or purchase_id != False"/>
        <button name="action_mark_back_from_vendor"
                type="object"
                string="Reçu du fournisseur"
                invisible="is_external == False"/>
      </xpath>

    </field>
  </record>
</odoo>
